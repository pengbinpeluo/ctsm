module AgSysLeaf
  use AgSysKinds,               only : r8
  use AgSysExcepUtils,          only : iulog, endrun
    
  implicit none
  private
  
  integer, parameter, public :: lai_expansion_rate_minval = -1
  integer, parameter, public :: lai_expansion_rate_not_used = 0
  integer, parameter, public :: lai_expansion_rate_default = 1
  integer, parameter, public :: lai_expansion_rate_pp = 2
  integer, parameter, public :: lai_expansion_rate_maxval = 3

  public :: canopy_expansion_actual
  public :: canopy_expansion_pot
contains
  subroutine canopy_expansion_actual(crop, leaf_expansion_rate_option, g_lai,&
                                     dlt_node_no_pot, dlt_leaf_no_pot, dlt_lai_stressed, dlt_leaf_dm, &
                                     dlt_node_no, dlt_leaf_no, dlt_lai)
    !!------------------------------
    !!determine the actual canopy growth (leaf area, leaf number, and node number) 
    !!using the supply-demand approach
    !!------------------------------
    class(agsys_crop_type_generic), intent(in) :: crop
    integer, intent(in) :: leaf_expansion_rate_option
    real(r8), intent(in) :: g_lai
    real(r8), intent(in) :: dlt_node_no_pot
    real(r8), intent(in) :: dlt_leaf_no_pot
    real(r8), intent(in) :: dlt_lai_stressed
    real(r8), intent(in) :: dlt_leaf_dm

    real(r8), intent(out) :: dlt_lai
    real(r8), intent(out) :: dlt_leaf_no
    real(r8), intent(out) :: dlt_node_no

    real(r8) :: sla_max
    real(r8) :: dlt_lai_carbon
    real(r8) :: dlt_lai
    real(r8) :: lai_ratio
    real(r8) :: leaf_no_frac
    
    !!actual change of leaf area index
    if (lai_expansion_rate_option == lai_expansion_rate_pp) then
      !!Set actual dlt LAI as "stressed dlt LAI" without SLA constraints
      dlt_lai = dlt_lai_stressed
    else if (lai_expansion_rate_option == lai_expansion_rate_default) then
      sla_max = interpolation(g_lai, crop%rc_sla_max)  !!calculated daily max spec leaf area
      dlt_lai_carbon = dlt_leaf_dm * sla_max * smm2sm !!maximum daily increase in leaf area
      !!index from carbon supply
      dlt_lai = min(dlt_lai_carbon, dlt_lai_stressed)
    else
      write(iulog, *) leaf_expansion_rate_option, " is not valid!"
      call endrun(msg="invalid_argument: leaf_expansion_rate_option")
    end if

    !!actual change of leaf number
    lai_ratio=max(dlt_lai/dlt_lai_stressed, 0.0) !!ratio of actual to potential lai
    leaf_no_frac = interpolation(lai_ratio, crop%rc_leaf_no_frac)  !!ratio of actual to potential leaf appearance
    dlt_leaf_no = dlt_leaf_no_pot * leaf_no_frac
    
    !!actual change of node number
    if (dlt_leaf_no < dlt_node_no_pot) then
      dlt_node_no = dlt_leaf_no
    else
      dlt_node_no = dlt_node_no_pot
    end if
  end subroutine canopy_expansion_actual

  subroutine canopy_expansion_pot (crop, leaf_no_pot_option,lai_expansion_rate_opiton, &
                                   current_stage, dlt_tt, photo_period, node_no_now, &
                                   leaf_no_stress_factor, lai_stress_factor, plant_density, &
                                   dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node, dlt_lai_pot, dlt_lai_stressed)
    class(agsys_crop_type_generic), intent(in) :: crop
    integer,  intent(in)  :: leaf_no_pot_option
    integer,  intent(in)  :: lai_expansion_rate_option
    real(r8), intent(in)  :: current_stage
    real(r8), intent(in)  :: dlt_tt
    real(r8), intent(in)  :: photo_period
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(in)  :: leaf_no_stress_factor
    real(r8), intent(in)  :: lai_stress_factor
    real(r8), intent(in)  :: plant_density

    real(r8), intent(out) :: dlt_node_no_pot
    real(r8), intent(out) :: dlt_leaf_no_pot
    real(r8), intent(out) :: leaves_per_node
    real(r8), intent(out) :: dlt_lai_pot  
    real(r8), intent(out) :: dlt_lai_stressed

    call leaf_no_pot(crop, leaf_no_pot_option, current_stage, dlt_tt, photo_period, node_no_now, leaf_no_stress_factor, &
                     dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    if (lai_expansion_rate_option == lai_expansion_rate_pp) then
      call leaf_area_pot_pp(crop, photo_period, dlt_tt, dlt_lai_pot)
    else if (lai_expansion_rate_option == lai_expansion_rate_default) then
      call leaf_area_pot(crop, dlt_leaf_no_pot, node_no_now, plant_density, dlt_lai_pot)
    else
      write(iulog, *) leaf_expansion_rate_option, " is not valid!"
      call endrun(msg="invalid_argument: leaf_expansion_rate_option")
    end if
    
    dlt_lai_stressed = dlt_lai_pot * lai_stress_factor
  end subroutine canopy_expansion_pot
  
  subroutine leaf_area_pot(crop, dlt_leaf_no_pot, node_no_now, plant_density, dlt_lai_pot)
    class(agsys_crop_type_generic), intent(in) :: crop
    real(r8), intent(in)  :: dlt_leaf_no_pot
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(out) :: dlt_lai_pot
    real(r8) :: leaf_size

    leaf_size = interpolate(node_no_now, crop%rc_leaf_size)
    dlt_lai_pot = dlt_leaf_no_pot * leaf_size * smm2sm * plant_density
  end subroutine leaf_area_pot

  subroutine leaf_area_pot_pp(crop, photo_period, dlt_tt, dlt_lai_tt)
    class(agsys_crop_type_generic), intent(in) :: crop
    real(r8), intent(in) :: photo_period
    real(r8), intent(in) :: dlt_tt
    real(r8), intent(out):: dlt_lai_pot
    real(r8) :: lai_rate_photo

    lai_rate_photo = interpolate(photo_period, crop%rc_lai_rate_photo) !Leaf area expansion rate (m^2/m^2/oCd, i.e. LAI/oCd)
    dlt_lai_pot = dlt_tt * lai_rate_photo
  end subroutine leaf_area_potential_pp

  subroutine leaf_no_pot(crop, leaf_no_pot_option, current_stage, dlt_tt, photo_period, node_no_now, stress_factor, &
                         dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    !inout variables
    class(agsys_crop_type_generic), intent(in) :: crop
    integer,  intent(in)  :: leaf_no_pot_option
    real(r8), intent(in)  :: current_stage
    real(r8), intent(in)  :: dlt_tt
    real(r8), intent(in)  :: photo_period
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(in)  :: stress_factor

    !output variables
    real(r8), intent(out) :: dlt_leaf_no_pot
    real(r8), intent(out) :: dlt_node_no_pot
    real(r8), intent(out) :: leaves_per_node
    
    Select case (leaf_no_pot_option)
      case(1)
        call cproc_leaf_no_pot_1(crop, current_stage, dlt_tt, node_no_now, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
      case(2)
        call cproc_leaf_no_pot_2(crop, current_stage, dlt_tt, node_no_now, stress_factor, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
      case(3)
        call cproc_leaf_no_pot_3(crop, current_stage, photo_period, dlt_tt, node_no_now, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    end select
  end subroutine leaf_no_pot

  subroutine cproc_leaf_no_pot_1(crop, current_stage, dlt_tt, node_no_now, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    class(agsys_crop_type_generic), intent(in) :: crop
    real(r8), intent(in)  :: current_stage
    real(r8), intent(in)  :: dlt_tt
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(out) :: dlt_node_no_pot
    real(r8), intent(out) :: dlt_leaf_no_pot
    real(r8), intent(out) :: leaves_per_node

    integer  :: node_formation_index
    real(r8) :: node_app_rate
    type(composite_phase_type) :: node_formation_cphase

    node_formation_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_node_formation)
    if (node_formation_phase_index /= 0) then
      node_formation_cphase = crop%phases%composite_phases(node_formation_index)
      if (any(node_formation_cphase%child_phase_id==floor(current_stage))) then
        node_app_rate = interpolation(node_no_now, crop%rc_node_app_rate)
        dlt_node_no_pot = max(dlt_tt/node_app_rate, 0.0)
        
        leaves_per_node = interpolation(node_no_now, crop%rc_leaves_per_node)
        dlt_leaf_no_pot = dlt_node_no_pot * leaves_per_node
      else
        dlt_node_no_pot = 0._r8
        dlt_leaf_no_pot = 0._r8
        leaves_per_node = 0._r8
      end if
    else
      dlt_node_no_pot = 0._r8
      dlt_leaf_no_pot = 0._r8
      leaves_per_node = 0._r8
    end if
  end subroutine cproc_leaf_no_pot_1

  subroutine cproc_leaf_no_pot_2(crop, current_stage, dlt_tt, node_no_now, stress_factor, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    !this is specifically for wheat
    !may also work for other crops->combine cproc_leaf_no_pot1 and cproc_leaf_no_pot2???
    class(agsys_crop_type_generic), intent(in) :: crop
    real(r8), intent(in)  :: current_stage
    real(r8), intent(in)  :: dlt_tt
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(in)  :: stress_factor
    real(r8), intent(out) :: dlt_node_no_pot
    real(r8), intent(out) :: dlt_leaf_no_pot
    real(r8), intent(out) :: leaves_per_node

    integer  :: node_formation_index
    real(r8) :: node_app_rate
    real(r8) :: leaves_per_node_now
    real(r8) :: dlt_leaves_per_node
    type(composite_phase_type) :: node_formation_cphase

    node_formation_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_node_formation)
    if (node_formation_phase_index /= 0) then
      node_formation_cphase = crop%phases%composite_phases(node_formation_index)
      if (any(node_formation_cphase%child_phase_id==floor(current_stage))) then
        node_app_rate = interpolation(node_no_now, crop%rc_node_app_rate)
        dlt_node_no_pot = max(dlt_tt/node_app_rate, 0._r8)
        
        leaves_per_node_now = interpolation(node_no_now, crop%rc_leaves_per_node)
        leaves_per_node = min(leaves_per_node, leaves_per_node_now)
        dlt_leaves_per_node = interpolation(node_no_now + dlt_node_no_pot) - leaves_per_node_now
        leaves_per_node = leaves_per_node + dlt_leaves_per_node * stress_factor
        dlt_leaf_no_pot = dlt_node_no_pot * leaves_per_node
      else
        dlt_node_no_pot = 0._r8
        dlt_leaf_no_pot = 0._r8
        leaves_per_node = 0._r8
      end if
    else
      dlt_node_no_pot = 0._r8
      dlt_leaf_no_pot = 0._r8
      leaves_per_node = 0._r8
    end if
  end subroutine cproc_leaf_no_pot_2
  
  subroutine cproc_leaf_no_pot_3(crop, current_stage, photo_period, dlt_tt, node_no_now, dlt_node_no_pot, dlt_leaf_no_pot, leaves_per_node)
    class(agsys_crop_type_generic), intent(in) :: crop
    real(r8), intent(in)  :: current_stage
    real(r8), intent(in)  :: photo_period
    real(r8), intent(in)  :: dlt_tt
    real(r8), intent(in)  :: node_no_now
    real(r8), intent(out) :: dlt_node_no_pot
    real(r8), intent(out) :: dlt_leaf_no_pot
    real(r8), intent(out) :: leaves_per_node

    integer  :: node_formation_index
    integer  :: pre_photo_phyllochron_index
    integer  :: photo_phyllochron_index
    integer  :: post_phyllochron_index
    real(r8) :: node_app_rate

    type(composite_phase_type) :: node_formation_cphase
    type(composite_phase_type) :: pre_photo_phyllochron_cphase
    type(composite_phase_type) :: photo_phyllochron_cphase
    type(composite_phase_type) :: post_photo_phyllochron_cphase

    node_formation_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_node_formation)
    if (node_formation_phase_index /= 0) then
      node_formation_cphase = crop%phases%composite_phases(node_formation_index)
      if (any(node_formation_cphase%child_phase_id==floor(current_stage))) then
        pre_photo_phyllochron_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_pre_photo_phyllochron)
        photo_phyllochron_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_photo_phyllochron)
        post_photo_phyllochron_index  = crop%phases%composite_phase_index_from_type(composite_phase_type_post_photo_phyllochron)
        node_app_rate=0._r8
        if ((pre_photo_phyllochron_index /=0) .and. (photo_phyllochron_index /=0) .and. (post_photo_phyllochron_index /=0)) then
          if (any(pre_photo_phyllochron_cphase%child_phase_id==floor(current_stage))) then
            node_app_rate = crop%node_app_rate_pre_photo
          else if (any(photo_phyllochron_cphase%child_phase_id==floor(current_stage))) then
            node_app_rate = interpolation(photo_period, crop%rc_node_app_rate)
          else if (any(post_photo_phyllochron_cphase%child_phase_id==floor(current_stage))) then
            node_app_rate = crop%node_app_rate_post_photo
          else
            write(iulog, *) "invalid_argument: PhotoPhyllochron phases do not align with NodeFormationPhase!"
            call endrun(msg="invalid_argument: PhotoPhyllochron phases do not align with NodeFormationPhase!")
          end if
        end if
        dlt_node_no_pot = max(dlt_tt/node_app_rate, 0._r8)
        
        leaves_per_node = interpolation(node_no_now, crop%rc_leaves_per_node)
        dlt_leaf_no_pot = dlt_node_no_pot * leaves_per_node
      else
        dlt_node_no_pot = 0._r8
        dlt_leaf_no_pot = 0._r8
        leaves_per_node = 0._r8
      end if
    else
      dlt_node_no_pot = 0._r8
      dlt_leaf_no_pot = 0._r8
      leaves_per_node = 0._r8
    end if
  end subroutine cproc_leaf_no_pot_3

